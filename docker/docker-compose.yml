version: '3.8'

services:
  # ============================================================================
  # DATABASE - Shared PostgreSQL for both BlockScout instances
  # ============================================================================
  postgres:
    image: postgres:16-alpine
    container_name: blockscout-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${DB_USER:-blockscout}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-blockscout}
      POSTGRES_DB: ${DB_NAME:-blockscout}
      POSTGRES_INITDB_ARGS: "--encoding UTF8 -c shared_buffers=256MB -c effective_cache_size=1GB -c work_mem=16MB"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "${DB_PORT:-5432}:5432"
    networks:
      - blockscout-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-blockscout} -d ${DB_NAME:-blockscout}"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"

  # ============================================================================
  # REDIS - Cache for BlockScout
  # ============================================================================
  redis:
    image: redis:7-alpine
    container_name: blockscout-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-redis_password}
    volumes:
      - redis_data:/data
    ports:
      - "${REDIS_PORT:-6379}:6379"
    networks:
      - blockscout-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"

  # ============================================================================
  # BLOCKSCOUT BACKEND - Main Instance
  # ============================================================================
  blockscout-main-backend:
    image: blockscout/blockscout:latest
    container_name: blockscout-main-backend
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      # Database Configuration
      DATABASE_URL: postgresql://${DB_USER:-blockscout}:${DB_PASSWORD:-blockscout}@postgres:5432/${DB_NAME:-blockscout}
      REDIS_URL: redis://:${REDIS_PASSWORD:-redis_password}@redis:6379/0
      
      # Network Configuration
      ETHEREUM_JSONRPC_HTTP_URL: ${RPC_URL:-http://ev-reth-sequencer:8545}
      ETHEREUM_JSONRPC_TRACE_URL: ${RPC_URL:-http://ev-reth-sequencer:8545}
      ETHEREUM_JSONRPC_WS_URL: ${RPC_WS_URL:-ws://ev-reth-sequencer:8546}
      CHAIN_ID: ${CHAIN_ID:-42170}
      
      # Server Configuration
      PORT: 4000
      MIX_ENV: ${ENV:-prod}
      SECRET_KEY_BASE: ${SECRET_KEY_BASE:-your-secret-key-base-main}
      
      # Frontend Configuration
      BLOCKSCOUT_HOST: ${BLOCKSCOUT_HOST_MAIN:-explorer.ande.network}
      BLOCKSCOUT_PROTOCOL: ${BLOCKSCOUT_PROTOCOL:-https}
      
      # UI Configuration
      NETWORK_NAME: ${NETWORK_NAME_MAIN:-Ande Network}
      LOGO_URL: ${LOGO_URL_MAIN:-https://ande.network/logo.png}
      FOOTER_LOGO_URL: ${FOOTER_LOGO_URL_MAIN:-https://ande.network/logo-footer.png}
      
      # Features
      ENABLE_TXS_STATS: "true"
      SHOW_PRICE_CHART: "false"
      SHOW_MARKET_CAP_CHART: "false"
      DISPLAY_TOKEN_ICONS: "true"
      SHOW_VALIDATORS: "false"
      
      # Smart Contract Verification
      SMART_CONTRACT_VERIFICATION: "true"
      SMART_CONTRACT_SRC: "eth_bytecode_db"
      
      # API Configuration
      API_RATE_LIMIT_BY_KEY: "${API_RATE_LIMIT_BY_KEY:-50}"
      API_RATE_LIMIT_BY_IP: "${API_RATE_LIMIT_BY_IP:-100}"
      
      # Other Settings
      COIN: ETH
      DISABLE_EXCHANGE_RATES: "false"
    volumes:
      - blockscout-main-logs:/app/logs
    ports:
      - "4000:4000"
    networks:
      - blockscout-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/health"]
      interval: 30s
      timeout: 10s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"

  # ============================================================================
  # BLOCKSCOUT FRONTEND - Main Instance
  # ============================================================================
  blockscout-main-frontend:
    image: blockscout/frontend:latest
    container_name: blockscout-main-frontend
    restart: unless-stopped
    depends_on:
      - blockscout-main-backend
    environment:
      # API Configuration
      NEXT_PUBLIC_API_HOST: ${BLOCKSCOUT_HOST_MAIN:-explorer.ande.network}
      NEXT_PUBLIC_API_PROTOCOL: ${BLOCKSCOUT_PROTOCOL:-https}
      NEXT_PUBLIC_APP_HOST: ${BLOCKSCOUT_HOST_MAIN:-explorer.ande.network}
      NEXT_PUBLIC_APP_PROTOCOL: ${BLOCKSCOUT_PROTOCOL:-https}
      
      # Network Configuration
      NEXT_PUBLIC_NETWORK_NAME: ${NETWORK_NAME_MAIN:-Ande Network}
      NEXT_PUBLIC_NETWORK_LOGO: ${LOGO_URL_MAIN:-https://ande.network/logo.png}
      NEXT_PUBLIC_NETWORK_ID: ${CHAIN_ID:-42170}
      NEXT_PUBLIC_NETWORK_CURRENCY_DECIMALS: 18
      NEXT_PUBLIC_NETWORK_CURRENCY_NAME: ETH
      NEXT_PUBLIC_NETWORK_CURRENCY_SYMBOL: ETH
      
      # UI Configuration
      NEXT_PUBLIC_IS_ACCOUNT_ABSTRACTION_ENABLED: "false"
      NEXT_PUBLIC_IS_L2_NETWORK: "true"
      NEXT_PUBLIC_FOOTER_LINKS: "[]"
      
      # Features
      NEXT_PUBLIC_SHOW_GAS_TRACKER: "true"
      NEXT_PUBLIC_HIDE_INDEXING_ALERT: "false"
      
      # Analytics
      NEXT_PUBLIC_GA_ID: ""
      
      # Theme
      NEXT_PUBLIC_DEFAULT_THEME: "light"
      
    ports:
      - "3000:3000"
    networks:
      - blockscout-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"

  # ============================================================================
  # BLOCKSCOUT BACKEND - Advanced Instance
  # ============================================================================
  blockscout-advanced-backend:
    image: blockscout/blockscout:latest
    container_name: blockscout-advanced-backend
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      # Database Configuration
      DATABASE_URL: postgresql://${DB_USER:-blockscout}:${DB_PASSWORD:-blockscout}@postgres:5432/${DB_NAME:-blockscout}
      REDIS_URL: redis://:${REDIS_PASSWORD:-redis_password}@redis:6379/1
      
      # Network Configuration
      ETHEREUM_JSONRPC_HTTP_URL: ${RPC_URL:-http://ev-reth-sequencer:8545}
      ETHEREUM_JSONRPC_TRACE_URL: ${RPC_URL:-http://ev-reth-sequencer:8545}
      ETHEREUM_JSONRPC_WS_URL: ${RPC_WS_URL:-ws://ev-reth-sequencer:8546}
      CHAIN_ID: ${CHAIN_ID:-42170}
      
      # Server Configuration
      PORT: 4001
      MIX_ENV: ${ENV:-prod}
      SECRET_KEY_BASE: ${SECRET_KEY_BASE_ADV:-your-secret-key-base-advanced}
      
      # Frontend Configuration
      BLOCKSCOUT_HOST: ${BLOCKSCOUT_HOST_ADVANCED:-explorer-advanced.ande.network}
      BLOCKSCOUT_PROTOCOL: ${BLOCKSCOUT_PROTOCOL:-https}
      
      # UI Configuration
      NETWORK_NAME: ${NETWORK_NAME_ADVANCED:-Ande Network (Analytics)}
      LOGO_URL: ${LOGO_URL_ADVANCED:-https://ande.network/logo.png}
      FOOTER_LOGO_URL: ${FOOTER_LOGO_URL_ADVANCED:-https://ande.network/logo-footer.png}
      
      # Features - Advanced
      ENABLE_TXS_STATS: "true"
      SHOW_PRICE_CHART: "true"
      SHOW_MARKET_CAP_CHART: "true"
      DISPLAY_TOKEN_ICONS: "true"
      SHOW_VALIDATORS: "false"
      ENABLE_ADVANCED_ANALYTICS: "true"
      
      # Smart Contract Verification
      SMART_CONTRACT_VERIFICATION: "true"
      SMART_CONTRACT_SRC: "eth_bytecode_db"
      
      # API Configuration - Higher limits for advanced
      API_RATE_LIMIT_BY_KEY: "${API_RATE_LIMIT_BY_KEY_ADV:-200}"
      API_RATE_LIMIT_BY_IP: "${API_RATE_LIMIT_BY_IP_ADV:-500}"
      
      # Other Settings
      COIN: ETH
      DISABLE_EXCHANGE_RATES: "false"
    volumes:
      - blockscout-advanced-logs:/app/logs
    ports:
      - "4001:4001"
    networks:
      - blockscout-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4001/health"]
      interval: 30s
      timeout: 10s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"

  # ============================================================================
  # BLOCKSCOUT FRONTEND - Advanced Instance
  # ============================================================================
  blockscout-advanced-frontend:
    image: blockscout/frontend:latest
    container_name: blockscout-advanced-frontend
    restart: unless-stopped
    depends_on:
      - blockscout-advanced-backend
    environment:
      # API Configuration
      NEXT_PUBLIC_API_HOST: ${BLOCKSCOUT_HOST_ADVANCED:-explorer-advanced.ande.network}
      NEXT_PUBLIC_API_PROTOCOL: ${BLOCKSCOUT_PROTOCOL:-https}
      NEXT_PUBLIC_APP_HOST: ${BLOCKSCOUT_HOST_ADVANCED:-explorer-advanced.ande.network}
      NEXT_PUBLIC_APP_PROTOCOL: ${BLOCKSCOUT_PROTOCOL:-https}
      
      # Network Configuration
      NEXT_PUBLIC_NETWORK_NAME: ${NETWORK_NAME_ADVANCED:-Ande Network (Analytics)}
      NEXT_PUBLIC_NETWORK_LOGO: ${LOGO_URL_ADVANCED:-https://ande.network/logo.png}
      NEXT_PUBLIC_NETWORK_ID: ${CHAIN_ID:-42170}
      NEXT_PUBLIC_NETWORK_CURRENCY_DECIMALS: 18
      NEXT_PUBLIC_NETWORK_CURRENCY_NAME: ETH
      NEXT_PUBLIC_NETWORK_CURRENCY_SYMBOL: ETH
      
      # UI Configuration - Advanced Features
      NEXT_PUBLIC_IS_ACCOUNT_ABSTRACTION_ENABLED: "true"
      NEXT_PUBLIC_IS_L2_NETWORK: "true"
      NEXT_PUBLIC_SHOW_VALIDATORS: "false"
      
      # Features
      NEXT_PUBLIC_SHOW_GAS_TRACKER: "true"
      NEXT_PUBLIC_HIDE_INDEXING_ALERT: "false"
      NEXT_PUBLIC_ENABLE_ADVANCED_METRICS: "true"
      
      # Analytics
      NEXT_PUBLIC_GA_ID: ""
      
      # Theme
      NEXT_PUBLIC_DEFAULT_THEME: "light"
      
    ports:
      - "3001:3000"
    networks:
      - blockscout-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"

  # ============================================================================
  # NGINX REVERSE PROXY
  # ============================================================================
  nginx:
    image: nginx:alpine
    container_name: blockscout-nginx
    restart: unless-stopped
    depends_on:
      - blockscout-main-frontend
      - blockscout-main-backend
      - blockscout-advanced-frontend
      - blockscout-advanced-backend
    volumes:
      - ../infra/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ../infra/nginx/sites/:/etc/nginx/conf.d/:ro
      - ../infra/nginx/ssl/:/etc/nginx/ssl/:ro
      - nginx_logs:/var/log/nginx
    ports:
      - "80:80"
      - "443:443"
    networks:
      - blockscout-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  blockscout-main-logs:
    driver: local
  blockscout-advanced-logs:
    driver: local
  nginx_logs:
    driver: local

networks:
  blockscout-network:
    driver: bridge
