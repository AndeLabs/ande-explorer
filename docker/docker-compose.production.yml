version: '3.8'

# Production overrides for Ande Explorer
# Use with: docker-compose -f docker-compose.yml -f docker-compose.production.yml up -d

services:
  # PostgreSQL Production Settings
  postgres:
    environment:
      POSTGRES_SHARED_PRELOAD_LIBRARIES: pg_stat_statements
      POSTGRES_MAX_CONNECTIONS: 200
      POSTGRES_SHARED_BUFFERS: 512MB
      POSTGRES_EFFECTIVE_CACHE_SIZE: 2GB
      POSTGRES_WORK_MEM: 32MB
      POSTGRES_MAINTENANCE_WORK_MEM: 128MB
      POSTGRES_CHECKPOINT_COMPLETION_TARGET: 0.9
      POSTGRES_WAL_BUFFERS: 16MB
      POSTGRES_DEFAULT_STATISTICS_TARGET: 100
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 2G
    logging:
      driver: "json-file"
      options:
        max-size: "200m"
        max-file: "20"

  # Redis Production Settings
  redis:
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD} --maxmemory 1gb --maxmemory-policy allkeys-lru
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "15"

  # BlockScout Main Backend Production
  blockscout-main-backend:
    environment:
      MIX_ENV: prod
      POOL_SIZE: 20
      QUEUE_INTERVAL: 5000
      CACHE_PERIOD: 600
      SANITY_CHECK_INTERVAL: 10000
      DISABLE_WEBAPP: "false"
      API_RATE_LIMIT_BY_KEY: ${API_RATE_LIMIT_BY_KEY}
      API_RATE_LIMIT_BY_IP: ${API_RATE_LIMIT_BY_IP}
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 2G
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    logging:
      driver: "json-file"
      options:
        max-size: "200m"
        max-file: "20"

  # BlockScout Main Frontend Production
  blockscout-main-frontend:
    environment:
      NODE_ENV: production
      NEXT_TELEMETRY_DISABLED: 1
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "15"

  # BlockScout Advanced Backend Production
  blockscout-advanced-backend:
    environment:
      MIX_ENV: prod
      POOL_SIZE: 30
      QUEUE_INTERVAL: 3000
      CACHE_PERIOD: 300
      SANITY_CHECK_INTERVAL: 5000
      DISABLE_WEBAPP: "false"
      API_RATE_LIMIT_BY_KEY: ${API_RATE_LIMIT_BY_KEY_ADV}
      API_RATE_LIMIT_BY_IP: ${API_RATE_LIMIT_BY_IP_ADV}
      ENABLE_ADVANCED_ANALYTICS: "true"
    deploy:
      resources:
        limits:
          memory: 6G
        reservations:
          memory: 3G
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    logging:
      driver: "json-file"
      options:
        max-size: "300m"
        max-file: "25"

  # BlockScout Advanced Frontend Production
  blockscout-advanced-frontend:
    environment:
      NODE_ENV: production
      NEXT_TELEMETRY_DISABLED: 1
      NEXT_PUBLIC_ENABLE_ADVANCED_METRICS: "true"
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    logging:
      driver: "json-file"
      options:
        max-size: "150m"
        max-file: "20"

  # Nginx Production Settings
  nginx:
    volumes:
      - ../infra/nginx/nginx-production.conf:/etc/nginx/nginx.conf:ro
      - ../infra/nginx/sites:/etc/nginx/conf.d:ro
      - ../infra/nginx/ssl:/etc/nginx/ssl:ro
      - nginx_logs:/var/log/nginx
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "10"

# Production-specific volumes with backup strategies
volumes:
  postgres_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /var/lib/postgresql/ande-explorer-data
  redis_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /var/lib/redis/ande-explorer-data
  blockscout-main-logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /var/log/blockscout/main
  blockscout-advanced-logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /var/log/blockscout/advanced
  nginx_logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /var/log/nginx/ande-explorer